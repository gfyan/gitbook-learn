# 缓存相关问题

### 你们用了缓存，一般都遇到了哪些问题？

**写入问题：**
- 缓存一致性问题，1.写缓存成功但是写数据库失败，2.写数据库成功但是写缓存成功，3.失效缓存删除失败，导致缓存不一致情况。
- 并发写入问题，怎么防止多线程并发写入缓存。

**查询问题：**
- 缓存击穿问题，因为某一个极高访问量的热点key数据过期被删除，导致所有的查询都打到DB上，最终导致DB服务不可用从而影响其他业务。
- 缓存雪崩问题，比如大促销活动中，某一批热点key同时过期，导致所有的查询都打到DB上，最终导致服务不可用。
- 缓存穿透问题，因为一直访问不存在的key，业务一直查询数据库，最终导致不可用。

### 当查询缓存报错时，怎么提高可用性？

首先查看报错存是属于那种错误，如果是缓存应用不可用宕机的话，需要对缓存应用集群部署，并且可以增加备用区的方式去提高可用性。
如果是数据不存在的话需要维护好业务代码，去DB获取未查询到的数据，然后将返回结果设置到缓存中，提高可用性。

### 如何避免缓存穿透问题？

缓存穿透是大批量请求缓存中不存在的数据，从而导致所有请求都打到DB上去，最终导致服务不可用的情况，避免这个问题可以通过两种方式：

1. 可以对现有的数据进行数据统计，排除掉恶意的请求，直接将明显不符合目前系统数据的请求直接丢弃掉，或者直接响应空给请求方。
2. 可以对不存在的数据进行空值缓存存储，使得后续的请求不会打的DB上。
3. 使用BloomFilter过滤器，每日凌晨对现有的数据key进行初始化到BloomFilter过滤器上，然后每次请求通过BloomFilter判断，如果BloomFilter过滤器判断不存在，那么这个值一定不存在，则对对应的请求进行丢弃或返回空处理。

### 如何避免缓存雪崩问题？

**缓存雪崩的原因：**
有可能是大批量的热点key数据同时失效，或者缓存服务不可用，两种情况都会导致大量的请求到DB上。

针对服务不可用的情况，可以搭建缓存集群，可以使用主从架构或者多应用分区架构，最后还可以加一个阿里云备用区，防止某一个阿里云可用区挂了之后，其他地区的服务给顶上。

针对大批量的key失效情况可以在代码上进行规范，每次设置key都可以在业务规定失效时间上加一个120s内的随机值，防止大批量数据同时失效，当然也可以针对热点key设置为永不失效，但是这样会导致缓存内存的浪费，最终可能导致缓存内存不足情况，影响其他业务。


### 如何避免缓存击穿问题？

**缓存击穿的原因：**

某一个极度热点的key失效导致高并发的请求打到DB上，最终导致其他服务不可用。

针对缓存击穿我们可以出以下方案：
1. 极度热点key设置永不过期，过期删除完全通过手动判断，如果时效性不是特别强的，可以在key的value中存放过期时间，如果查询数据发现该key已经过期，那么立马采用一个异步线程去进行缓存更新，但是当前查询还是依旧返回，保证服务的可用性。

2. 针对已经过期的热点key获取数据逻辑进行单线程话，如果key已经过期通过分布式锁去获取查询DB的许可，获得许可后去DB查询并将数据设置到缓存中，如果获取分布式锁失败，则一直重试直到获得锁成功或者缓存有值才进行下一步操作。






